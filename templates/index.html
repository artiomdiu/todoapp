<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Todo App</title>
    <style>
      .hidden {
        display: none;
      }
      ul {
        list-style: none;
        padding: 0;
        margin: 0;
          width: 300px;
      }
      li {
          clear: both;
      }
      li button {
          -webkit-appearance: none;
          border: none;
          outline: none;
          color: red;
          float: right;
          cursor: pointer;
          font-size: 20px;
      }
      .lists-wrapper, .todos-wrapper {
          display: inline-block;
          vertical-align: top;
      }
    </style>
  </head>
  <body>
    <h3>TODO APP</h3>
    <div class="lists-wrapper">
        <h4>TODO LISTS</h4>
        <form id="list-form" method="post" action="/lists/create">
            <input type="text" id="name" name="name" />
            <input type="submit" value="Create" />
        </form>
        <div id="error" class="hidden">Something went wrong!</div>
        <ul id="lists">
            {%  for list in lists %}
            <li>
                <input class="check-list-completed" data-id="{{ list.id }}" type="checkbox" {% if list.completed %} checked {% endif %} />
                <a href="/lists/{{ list.id }}">
                    {{ list.name }}
                </a>
{#                <button class="delete-button" data-id="{{ list.id }}">&cross;</button>#}
            </li>
            {% endfor %}
        </ul>
    </div>
    <script>
        const listCheckboxes = document.querySelectorAll('.check-list-completed');
        for (let i = 0; i < listCheckboxes.length; i++) {
            const checkbox_list = listCheckboxes[i];
            checkbox_list.onchange = function(e) {
              const newCompleted = e.target.checked;
              const listId = e.target.dataset['id'];
              fetch('/lists/' + listId + '/set-completed', {
                method: 'POST',
                body: JSON.stringify({
                  'completed': newCompleted
                }),
                headers: {
                  'Content-Type': 'application/json'
                }
              })
              .then(function(jsonResponse) {
                document.getElementById('error').className = 'hidden';
                const todoCheckboxes = document.querySelectorAll('.todo-check-completed');
                for (let i = 0; i < todoCheckboxes.length; i++) {
                    const checkbox = todoCheckboxes[i];
                    checkbox.checked = true;
                }
              })
              .catch(function() {
                document.getElementById('error').className = '';
              })
            }
        }
        document.getElementById('list-form').onsubmit = function(e) {
            e.preventDefault();
            fetch('/lists/create', {
              method: 'POST',
              body: JSON.stringify({
                'name': document.getElementById('name').value,
              }),
              headers: {
                'Content-Type': 'application/json',
              }
            })
            .then(response => response.json())
            .then(jsonResponse => {
              const li = document.createElement('li');
              const checkbox_list = document.createElement('input');
              checkbox_list.className = 'check-list-completed';
              checkbox_list.type = 'checkbox';
              checkbox_list.setAttribute('data-id', jsonResponse.id);
              li.appendChild(checkbox_list);

              const text_list = document.createTextNode(' ' + jsonResponse.name);
              li.appendChild(text_list);

              {#const deleteBtn = document.createElement('button');#}
              {#deleteBtn.className = 'delete-button';#}
              {#deleteBtn.setAttribute('data-id', jsonResponse.id);#}
              {#deleteBtn.innerHTML = '&cross;';#}
              {#li.appendChild(deleteBtn);#}

              document.getElementById('lists').appendChild(li);
              document.getElementById('error').className = 'hidden';
            })
            .catch(function() {
              console.error('Error occurred');
              document.getElementById('error').className = '';
            })
        }
    </script>
    <div class="todos-wrapper">
        <h4>TODO ITEMS: {{ active_list.name }}</h4>
        <form id="todo-form" method="post" action="/todos/create">
            <input id="list_id" type="hidden" value="{{ active_list.id }}"/>
            <input type="text" id="description" name="description" />
            <button type="submit">Create Task</button>
        </form>
        <div id="error" class="hidden">Something went wrong!</div>
        <ul id="todos">
          {% for todo in todos %}
          <li>
            <input class="todo-check-completed" data-id="{{ todo.id }}" type="checkbox" {% if todo.completed %} checked {% endif %} />
            {{ todo.description }}
            <button class="delete-button" data-id="{{ todo.id }}">&cross;</button>
          </li>
          {% endfor %}
        </ul>
    </div>
    <script>
      const todoCheckboxes = document.querySelectorAll('.todo-check-completed');
      for (let i = 0; i < todoCheckboxes.length; i++) {
        const checkbox = todoCheckboxes[i];
        checkbox.onchange = function(e) {
          const newCompleted = e.target.checked;
          const todoId = e.target.dataset['id'];
          fetch('/todos/' + todoId + '/set-completed', {
            method: 'POST',
            body: JSON.stringify({
              'completed': newCompleted
            }),
            headers: {
              'Content-Type': 'application/json'
            }
          })
          .then(function() {
            document.getElementById('error').className = 'hidden';
          })
          .catch(function() {
            document.getElementById('error').className = '';
          })
        }
      }
      const deleteBtns = document.querySelectorAll('.delete-button');
      for (let i = 0; i < deleteBtns.length; i++) {
          const btn = deleteBtns[i];
          btn.onclick = function (e) {
              const todoId = e.target.dataset['id'];
              fetch('/todos/' + todoId, {
                  method: 'DELETE'
              });
          }
      }
      document.getElementById('todo-form').onsubmit = function(e) {
        e.preventDefault();
        fetch('/todos/create', {
          method: 'POST',
          body: JSON.stringify({
              'description': document.getElementById('description').value,
              'list_id': document.getElementById('list_id').value
          }),
          headers: {
            'Content-Type': 'application/json',
          }
        })
        .then(response => response.json())
        .then(jsonResponse => {
          const li = document.createElement('li');
          const checkbox = document.createElement('input');
          checkbox.className = 'check-completed';
          checkbox.type = 'checkbox';
          checkbox.setAttribute('data-id', jsonResponse.id);
          li.appendChild(checkbox);

          const text = document.createTextNode(' ' + jsonResponse.description);
          li.appendChild(text);

          {#const deleteBtn = document.createElement('button');#}
          {#deleteBtn.className = 'delete-button';#}
          {#deleteBtn.setAttribute('data-id', jsonResponse.id);#}
          {#deleteBtn.innerHTML = '&cross;';#}
          {#li.appendChild(deleteBtn);#}

          document.getElementById('todos').appendChild(li);
          document.getElementById('error').className = 'hidden';
        })
        .catch(function() {
          console.error('Error occurred');
          document.getElementById('error').className = '';
        })
      }
    </script>
  </body>
</html>